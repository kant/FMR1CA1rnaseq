---
title: "Behavior Data Analysis"
author: "Rayna M Harris"
date: "Last updated November 22, 2017"
output: md_document
---

```{r setup, message=F}
## load libraries 
library(tidyr) ## for respahing data
library(plyr) ## for renmaing factors
library(dplyr) ## for filtering and selecting rows
library(reshape2) ## for melting dataframe
library(ggplot2)
library(cowplot)
library(pheatmap)
library(viridis)
library(ez) # for non-parametric ANOVA

## load color settings
source("figureoptions.R")

knitr::opts_chunk$set(fig.path = '../figures/01_behavior/')

```


```{r behaivordata, message=F}
## read intermediate data (raw data from video tracker program analyzed in matlab)
behavior <- read.csv("../data/fmr1.csv", header = T)

behavior$APA <- as.factor(behavior$APA)
behavior$APA2 <- as.factor(behavior$APA2)


## relevel then rename factors treatment
behavior$APA2 <- factor(behavior$APA2, levels = c("controlconsistent", "consistent", "controlconflict", "conflict"))
levels(behavior$APA2) <- c("yoked-consistent","consistent", "yoked-conflict","conflict")
levels(behavior$APA2)

#relevel genotype
levels(behavior$Genotype) <- c("WT","FMR1KO")
#levels(behavior$conflict) <- c("consistent","conflict")

behavior$Time1stEntrLog <- log(behavior$Time1stEntr)  ## log transformation
behavior$conflict <- ifelse(grepl("conflict", behavior$APA2), "conflict", "consistent") # for splitting
levels(behavior$conflict) <- c("consistent","conflict")
behavior <- behavior[c(1,3,7,8,10,60,14:59)] # supset data
behavior <- subset(behavior, !is.na(behavior$NumEntrances)) # remove nas

# sample sizes
behavior %>% 
  filter(TrainSessionCombo == "Retention") %>%
  select(APA2)  %>%  summary()

behavior %>% 
  filter(TrainSessionCombo == "Retention", Genotype == "WT") %>%
  select(APA2, Genotype)  %>%  summary()

behavior %>% 
  filter(TrainSessionCombo == "Retention", Genotype == "FMR1KO") %>%
  select(APA2, Genotype)  %>%  summary()
```

```{r}
# num entrances
numentr <- dplyr::summarise(group_by(behavior, Genotype, APA2, TrainSessionComboNum, conflict), m = mean(NumEntrances), se = sd(NumEntrances)/sqrt(length(NumEntrances)), len = length(NumEntrances))

ptime <- dplyr::summarise(group_by(behavior, Genotype, APA2, TrainSessionComboNum, conflict), m = mean(pTimeTarget), se = sd(pTimeTarget)/sqrt(length(pTimeTarget)), len = length(pTimeTarget))

levels(numentr$APA2) <- c("yoked-consistent","consistent", "yoked-conflict","conflict")
numentr$conflict = factor(numentr$conflict, levels = c("consistent","conflict"))
levels(numentr$conflict) <- c("Initial learning","Cognitive discrimination")

oneplot <- ggplot(numentr, aes(x=, TrainSessionComboNum, y=m, color=APA2, shape=Genotype)) + 
    geom_errorbar(aes(ymin=m-se, ymax=m+se), width=.1) +
    geom_point(size = 2) +
   geom_line(aes(colour=APA2, linetype=Genotype)) +
   scale_y_continuous(name= "Number of Entrances") +
    scale_x_continuous(name="Training Session", 
                       breaks = c(1, 2, 3, 4, 5, 6, 7, 8, 9),
                       labels = c( "Pre.", "T1", "T2", "T3",
                                   "Retest", "T4/C1", "T5/C2", 
                                   "T6/C3", "Reten.")) +
  theme_cowplot(font_size = 8, line_size = 0.25) +
  #background_grid(major = "y", minor = "y") +
  scale_color_manual(values = colorvalAPA00)  +
  theme(legend.title=element_blank()) +
  #theme(legend.position="none") +
  scale_shape_manual(values=c(16, 1)) 
oneplot


pdf(file="../figures/01_behavior/oneplot.pdf", width=6, height=3)
plot(oneplot)
dev.off()


twoplot <- ggplot(numentr, aes(x=, TrainSessionComboNum, y=m, color=APA2, shape=Genotype)) + 
    geom_errorbar(aes(ymin=m-se, ymax=m+se), width=.1) +
    geom_point(size = 2) +
   geom_line(aes(colour=APA2, linetype=Genotype)) +
   scale_y_continuous(name= "Number of Entrances") +
    scale_x_continuous(name="Training Session", 
                       breaks = c(1, 2, 3, 4, 5, 6, 7, 8, 9),
                       labels = c( "Pre.", "T1", "T2", "T3",
                                   "Retest", "T4/C1", "T5/C2", "T6/C3", "Reten.")) +
  theme_cowplot(font_size = 8, line_size = 0.25) +
  background_grid(major = "y", minor = "y") +
  scale_color_manual(values = colorvalAPA00)  +
  theme(legend.title=element_blank()) +
  #theme(legend.position="none") +
  scale_shape_manual(values=c(16, 1)) +
  facet_wrap(~conflict, nrow = 2) 
twoplot

pdf(file="../figures/01_behavior/twoplot.pdf", width=4.5, height=4)
plot(twoplot)
dev.off()

```


## Anovas Consistent only - No significant effect of genotype
```{r anovaconsistent}
consistent <- behavior %>%
  filter(conflict == "consistent")  %>%
  filter(TrainSessionCombo != "Hab", TrainSessionCombo != "Retention") %>%
  droplevels()

m1 = aov(NumEntrances ~  Genotype + APA2 + TrainSessionCombo + Genotype * APA2  , data=consistent)
summary(m1)
TukeyHSD(m1)

hab <- consistent %>%
  filter(TrainSession == "Hab") 
T1 <- consistent %>%
  filter(TrainSession == "T1") 
T2 <- consistent %>%
  filter(TrainSession == "T2") 
T3 <- consistent %>%
  filter(TrainSession == "T3") 
Retest <- consistent %>%
  filter(TrainSession == "Retest") 
T4 <- consistent %>%
  filter(TrainSession %in% c("T4", "C1")) 
T5 <- consistent %>%
  filter(TrainSession %in% c("T5", "C2")) 
T6 <- consistent %>%
  filter(TrainSession %in% c("T6", "C3")) 
Retention <- consistent %>%
  filter(TrainSession == "Retention") 

summary(aov(NumEntrances ~ Genotype * APA2, data=hab)) 
summary(aov(NumEntrances ~ Genotype * APA2, data=T1)) 
summary(aov(NumEntrances ~ Genotype * APA2, data=T2)) 
summary(aov(NumEntrances ~ Genotype * APA2, data=T3))
summary(aov(NumEntrances ~ Genotype * APA2, data=Retest)) 
summary(aov(NumEntrances ~ Genotype * APA2, data=T4)) 
summary(aov(NumEntrances ~ Genotype * APA2, data=T5)) 
summary(aov(NumEntrances ~ Genotype * APA2, data=T6)) 
summary(aov(NumEntrances ~ Genotype * APA2, data=Retention)) 
```


## Anovas Conflict  only
```{r anovaconflict}
conflict <- behavior %>%
  filter(conflict == "conflict") %>%
  filter(TrainSessionCombo != "Hab", TrainSessionCombo != "Retention", TrainSessionCombo != "T1", TrainSessionCombo != "T2",TrainSessionCombo != "T3") %>%
  droplevels()


m1 = aov(NumEntrances ~  Genotype + APA2 + TrainSessionCombo + Genotype * APA2  , data=conflict)
summary(m1)
TukeyHSD(m1)


hab <- conflict %>%
  filter(TrainSession == "Hab") 
T1 <- conflict %>%
  filter(TrainSession == "T1") 
T2 <- conflict %>%
  filter(TrainSession == "T2") 
T3 <- conflict %>%
  filter(TrainSession == "T3") 
Retest <- conflict %>%
  filter(TrainSession == "Retest") 
T4 <- conflict %>%
  filter(TrainSession %in% c("T4", "C1")) 
T5 <- conflict %>%
  filter(TrainSession %in% c("T5", "C2")) 
T6 <- conflict %>%
  filter(TrainSession %in% c("T6", "C3")) 
Retention <- conflict %>%
  filter(TrainSession == "Retention") 

summary(aov(NumEntrances ~ Genotype * APA2, data=hab)) # . genotype
summary(aov(NumEntrances ~ Genotype * APA2, data=T1)) 
summary(aov(NumEntrances ~ Genotype * APA2, data=T2)) 
summary(aov(NumEntrances ~ Genotype * APA2, data=T3))     # ** significant
summary(aov(NumEntrances ~ Genotype * APA2, data=Retest)) # * significant
summary(aov(NumEntrances ~ Genotype * APA2, data=T4)) 
TukeyHSD(aov(NumEntrances ~ Genotype * APA2, data=T4))
summary(aov(NumEntrances ~ Genotype * APA2, data=T5)) 
summary(aov(NumEntrances ~ Genotype * APA2, data=T6))     # * significant
summary(aov(NumEntrances ~ Genotype * APA2, data=Retention)) 
```

## Mann-Whitney Conflict-trained  only
```{r anovaconflicttrained}
conflict <- behavior %>%
  filter(APA2 == "conflict") %>%
  droplevels()

m1 = aov(NumEntrances ~  Genotype + TrainSessionCombo + Genotype*TrainSessionCombo, data=conflict)
summary(m1)
TukeyHSD(m1)

hab <- conflict %>%
  filter(TrainSession == "Hab") 
T1 <- conflict %>%
  filter(TrainSession == "T1") 
T2 <- conflict %>%
  filter(TrainSession == "T2") 
T3 <- conflict %>%
  filter(TrainSession == "T3") 
Retest <- conflict %>%
  filter(TrainSession == "Retest") 
T4 <- conflict %>%
  filter(TrainSession %in% c("T4", "C1")) 
T5 <- conflict %>%
  filter(TrainSession %in% c("T5", "C2")) 
T6 <- conflict %>%
  filter(TrainSession %in% c("T6", "C3")) 
Retention <- conflict %>%
  filter(TrainSession == "Retention") 

wilcox.test(NumEntrances ~ Genotype,  data=hab) 
wilcox.test(NumEntrances ~ Genotype, data=T1)
wilcox.test(NumEntrances ~ Genotype, data=T2) 
wilcox.test(NumEntrances ~ Genotype, data=T3)    
wilcox.test(NumEntrances ~ Genotype, data=Retest) 
wilcox.test(NumEntrances ~ Genotype, data=T4) 
wilcox.test(NumEntrances ~ Genotype, data=T5) 
wilcox.test(NumEntrances ~ Genotype, data=T6)     # . p = 0.099
wilcox.test(NumEntrances ~ Genotype, data=Retention)
```

## Mann-Whitney conflict-yoked  only
```{r anovacconflictyoked}
yoked <- behavior %>%
  filter(APA2 == "yoked-conflict")  %>%
  droplevels()

m1 = aov(NumEntrances ~  Genotype + TrainSessionCombo + Genotype*TrainSessionCombo, data=yoked)
summary(m1)

hab <- yoked %>%
  filter(TrainSession == "Hab") 
T1 <- yoked %>%
  filter(TrainSession == "T1") 
T2 <- yoked %>%
  filter(TrainSession == "T2") 
T3 <- yoked %>%
  filter(TrainSession == "T3") 
Retest <- yoked %>%
  filter(TrainSession == "Retest") 
T4 <- yoked %>%
  filter(TrainSession %in% c("T4", "C1")) 
T5 <- yoked %>%
  filter(TrainSession %in% c("T5", "C2")) 
T6 <- yoked %>%
  filter(TrainSession %in% c("T6", "C3")) 
Retention <- yoked %>%
  filter(TrainSession == "Retention") 

wilcox.test(NumEntrances ~ Genotype, data=hab) 
wilcox.test(NumEntrances ~ Genotype, data=T1)
wilcox.test(NumEntrances ~ Genotype, data=T2) 
wilcox.test(NumEntrances ~ Genotype, data=T3)    
wilcox.test(NumEntrances ~ Genotype, data=Retest) 
wilcox.test(NumEntrances ~ Genotype, data=T4) 
wilcox.test(NumEntrances ~ Genotype, data=T5) 
wilcox.test(NumEntrances ~ Genotype, data=T6)     
wilcox.test(NumEntrances ~ Genotype, data=Retention)
```


## Mann-Whitney consistent-trained  only
```{r anovaconsistentrained}
consistent <- behavior %>%
  filter(APA2 == "consistent") %>%
  droplevels()

m1 = aov(NumEntrances ~  Genotype + TrainSessionCombo + Genotype*TrainSessionCombo, data=consistent)
summary(m1)


hab <- consistent %>%
  filter(TrainSession == "Hab") 
T1 <- consistent %>%
  filter(TrainSession == "T1") 
T2 <- consistent %>%
  filter(TrainSession == "T2") 
T3 <- consistent %>%
  filter(TrainSession == "T3") 
Retest <- consistent %>%
  filter(TrainSession == "Retest") 
T4 <- consistent %>%
  filter(TrainSession %in% c("T4", "C1")) 
T5 <- consistent %>%
  filter(TrainSession %in% c("T5", "C2")) 
T6 <- consistent %>%
  filter(TrainSession %in% c("T6", "C3")) 
Retention <- consistent %>%
  filter(TrainSession == "Retention") 

wilcox.test(NumEntrances ~ Genotype,  data=hab) 
wilcox.test(NumEntrances ~ Genotype, data=T1)
wilcox.test(NumEntrances ~ Genotype, data=T2) 
wilcox.test(NumEntrances ~ Genotype, data=T3)    
wilcox.test(NumEntrances ~ Genotype, data=Retest) 
wilcox.test(NumEntrances ~ Genotype, data=T4) 
wilcox.test(NumEntrances ~ Genotype, data=T5) 
wilcox.test(NumEntrances ~ Genotype, data=T6)     
wilcox.test(NumEntrances ~ Genotype, data=Retention)
```

## Mann-Whitney consistent-yoked  only
```{r anovaconsistenyoked}
yoked <- behavior %>%
  filter(APA2 == "yoked-consistent") %>%
  droplevels()

m1 = aov(NumEntrances ~  Genotype + TrainSessionCombo + Genotype*TrainSessionCombo, data=yoked)
summary(m1)


hab <- yoked %>%
  filter(TrainSession == "Hab") 
T1 <- yoked %>%
  filter(TrainSession == "T1") 
T2 <- yoked %>%
  filter(TrainSession == "T2") 
T3 <- yoked %>%
  filter(TrainSession == "T3") 
Retest <- yoked %>%
  filter(TrainSession == "Retest") 
T4 <- yoked %>%
  filter(TrainSession %in% c("T4", "C1")) 
T5 <- yoked %>%
  filter(TrainSession %in% c("T5", "C2")) 
T6 <- yoked %>%
  filter(TrainSession %in% c("T6", "C3")) 
Retention <- yoked %>%
  filter(TrainSession == "Retention") 

wilcox.test(NumEntrances ~ Genotype, data=hab) 
wilcox.test(NumEntrances ~ Genotype, data=T1)
wilcox.test(NumEntrances ~ Genotype, data=T2) 
wilcox.test(NumEntrances ~ Genotype, data=T3)    
wilcox.test(NumEntrances ~ Genotype, data=Retest) 
wilcox.test(NumEntrances ~ Genotype, data=T4) 
wilcox.test(NumEntrances ~ Genotype, data=T5) 
wilcox.test(NumEntrances ~ Genotype, data=T6)     
wilcox.test(NumEntrances ~ Genotype, data=Retention)
```



## anova habituation

```{r}
slim1 <- behavior[,c(2,4,8,13:52)]
slim2 <- slim1 %>% filter(TrainSession == "Hab") 
Genotype <- slim2[,1]
APA <- slim2[,3]
slim3 <- slim2[,c(4:43)]

for(y in names(slim3)){
  ymod<- summary(aov(slim3[[y]] ~ Genotype * APA))
  cat(paste('\nDependent var:', y, '\n'))
  print(ymod)
}
```

## anova conflict

```{r}
slim1 <- behavior[,c(2,9,8,13:52)]
slim2 <- slim1 %>% filter(TrainSessionCombo == "T4_C1", APA2 == "conflict") 
Genotype <- slim2[,1]
APA <- slim2[,3]
slim3 <- slim2[,c(4:43)]

for(y in names(slim3)){
  ymod<- summary(aov(slim3[[y]] ~ Genotype ))
  cat(paste('\nDependent var:', y, '\n'))
  print(ymod)
}
# * AnnularSd, AnnularMaxBin 
# . PolarMinBin 

slim1 <- behavior[,c(2,9,8,13:52)]
slim2 <- slim1 %>% filter(TrainSessionCombo == "T3", APA2 == "conflict") 
Genotype <- slim2[,1]
APA <- slim2[,3]
slim3 <- slim2[,c(4:43)]

for(y in names(slim3)){
  ymod<- summary(aov(slim3[[y]] ~ Genotype ))
  cat(paste('\nDependent var:', y, '\n'))
  print(ymod)
}
# . AnnularSd, AnnularMinVal, MaxTimeAvoid 


```

## habituation genotype

```{r}
slim1 <- behavior[,c(2,9,8,13:52)]
slim2 <- slim1 %>% filter(TrainSessionCombo == "Hab") 
Genotype <- slim2[,1]
APA <- slim2[,3]
slim3 <- slim2[,c(4:43)]

for(y in names(slim3)){
  ymod<- summary(aov(slim3[[y]] ~ Genotype ))
  cat(paste('\nDependent var:', y, '\n'))
  print(ymod)
}

# . Speed1, AnnularMinBin 


```

## retention genotype

```{r}
slim1 <- behavior[,c(2,9,8,13:52)]
slim2 <- slim1 %>% filter(TrainSessionCombo == "Retention") 
Genotype <- slim2[,1]
APA <- slim2[,3]
slim3 <- slim2[,c(4:43)]

for(y in names(slim3)){
  ymod<- summary(aov(slim3[[y]] ~ Genotype * APA ))
  cat(paste('\nDependent var:', y, '\n'))
  print(ymod)
}
# ** Speed2ndEntr
# * RayleigAngle 
# . Min50.RngHiBin, RayleigLength, pTimeCCW, MaxTimeAvoid  


```